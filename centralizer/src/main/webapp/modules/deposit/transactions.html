<div class="page-container">
    <div class="page-header">
        <h2>Deposit Account Transactions</h2>
    </div>

    <div id="message-container"></div>

    <div class="form-group">
        <label for="account-id">Account ID</label>
        <input type="number" id="account-id" placeholder="Enter account ID to filter..." 
               onchange="loadTransactions()" min="1" style="width: 200px; display: inline-block;">
        <button class="btn btn-primary" onclick="loadTransactions()" style="margin-left: 10px;">
            Load Transactions
        </button>
        <button class="btn btn-secondary" onclick="clearFilter()" style="margin-left: 10px;">
            Clear Filter
        </button>
    </div>

    <div id="account-summary" style="margin: 20px 0; padding: 15px; background: #f5f5f5; border-radius: 4px; display: none;">
        <h3>Account Summary</h3>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
            <div>
                <strong>Account Number:</strong><br>
                <span id="summary-account-number"></span>
            </div>
            <div>
                <strong>Current Balance:</strong><br>
                <span id="summary-balance" style="font-size: 1.2em; color: #3c3;"></span>
            </div>
            <div>
                <strong>Customer ID:</strong><br>
                <span id="summary-customer"></span>
            </div>
        </div>
    </div>

    <div class="table-container">
        <table id="transactions-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Type</th>
                    <th>Amount</th>
                    <th>Balance After</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody id="transactions-tbody">
                <tr>
                    <td colspan="5" style="text-align: center; padding: 20px; color: #999;">
                        Enter an account ID and click "Load Transactions"
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
const DEPOSIT_API_URL = 'http://localhost:5000/api/deposit-accounts';

// Global function to load transactions for a specific account (called from list page)
window.loadDepositTransactions = function(accountId) {
    document.getElementById('account-id').value = accountId;
    loadTransactions();
};

function loadTransactions() {
    const accountId = document.getElementById('account-id').value;
    
    if (!accountId) {
        showMessage('Please enter an account ID', 'error');
        return;
    }

    const tbody = document.getElementById('transactions-tbody');
    tbody.innerHTML = '<tr><td colspan="5" class="loading">Loading transactions...</td></tr>';

    // Load account info first
    fetch(`${DEPOSIT_API_URL}/${accountId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Account not found');
            }
            return response.json();
        })
        .then(account => {
            showAccountSummary(account);
            return fetch(`${DEPOSIT_API_URL}/${accountId}/transactions`);
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to load transactions');
            }
            return response.json();
        })
        .then(transactions => {
            displayTransactions(transactions);
        })
        .catch(error => {
            console.error('Error:', error);
            tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: #c33;">
                Failed to load transactions: ${error.message}
            </td></tr>`;
            document.getElementById('account-summary').style.display = 'none';
        });
}

function showAccountSummary(account) {
    document.getElementById('summary-account-number').textContent = account.accountNumber;
    document.getElementById('summary-balance').textContent = formatCurrency(account.balance);
    document.getElementById('summary-customer').textContent = account.customerId;
    document.getElementById('account-summary').style.display = 'block';
}

function displayTransactions(transactions) {
    const tbody = document.getElementById('transactions-tbody');
    
    if (transactions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: #999;">No transactions found</td></tr>';
        return;
    }

    tbody.innerHTML = transactions.map(tx => {
        const typeClass = tx.type === 'DEPOSIT' ? 'style="color: #3c3; font-weight: bold;"' : 'style="color: #c33; font-weight: bold;"';
        const amountClass = tx.type === 'DEPOSIT' ? 'style="color: #3c3;"' : 'style="color: #c33;"';
        
        return `
        <tr>
            <td>${formatDateTime(tx.transactionDate)}</td>
            <td ${typeClass}>${tx.type}</td>
            <td ${amountClass}>${formatCurrency(tx.amount)}</td>
            <td style="font-weight: bold;">${formatCurrency(tx.balanceAfter)}</td>
            <td>${tx.description || '-'}</td>
        </tr>
    `;
    }).join('');
}

function clearFilter() {
    document.getElementById('account-id').value = '';
    document.getElementById('transactions-tbody').innerHTML = 
        '<tr><td colspan="5" style="text-align: center; padding: 20px; color: #999;">Enter an account ID and click "Load Transactions"</td></tr>';
    document.getElementById('account-summary').style.display = 'none';
}

function formatCurrency(amount) {
    return new Intl.NumberFormat('fr-FR', { 
        style: 'currency', 
        currency: 'EUR' 
    }).format(amount);
}

function formatDateTime(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleDateString('fr-FR') + ' ' + date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
}

function showMessage(message, type = 'success') {
    const container = document.getElementById('message-container');
    const className = type === 'success' ? 'success-message' : 'error-message';
    container.innerHTML = `<div class="${className}" style="padding: 10px; margin: 10px 0; border-radius: 4px; 
                            background: ${type === 'success' ? '#d4edda' : '#f8d7da'}; 
                            color: ${type === 'success' ? '#155724' : '#721c24'}; 
                            border: 1px solid ${type === 'success' ? '#c3e6cb' : '#f5c6cb'};">
                            ${message}
                           </div>`;
    setTimeout(() => container.innerHTML = '', 3000);
}
</script>
