<div class="page-container">
    <div class="page-header">
        <h2>Deposit to Savings Account</h2>
    </div>

    <div id="message-container"></div>

    <form id="deposit-form" onsubmit="return submitDeposit(event)">
        <div class="form-group">
            <label for="account-id">Account ID *</label>
            <input type="number" id="account-id" name="accountId" required 
                   placeholder="Enter account ID" min="1">
            <small style="color: #666;">Or search by account number below</small>
        </div>

        <div class="form-group">
            <label for="account-number">Account Number (Alternative)</label>
            <input type="text" id="account-number" name="accountNumber" 
                   placeholder="DEP-2024-001" onchange="searchByAccountNumber()">
        </div>

        <div class="form-group">
            <label for="amount">Deposit Amount *</label>
            <input type="number" id="amount" name="amount" 
                   step="0.01" min="0.01" required placeholder="0.00">
        </div>

        <div class="form-group">
            <label for="description">Description</label>
            <input type="text" id="description" name="description" 
                   placeholder="Optional description">
        </div>

        <div style="margin-top: 24px;">
            <button type="submit" class="btn btn-primary">Make Deposit</button>
            <button type="reset" class="btn btn-secondary" style="margin-left: 8px;">Reset</button>
            <button type="button" class="btn btn-secondary" onclick="loadPage('deposit', 'list')" 
                    style="margin-left: 8px;">Cancel</button>
        </div>
    </form>

    <div id="account-info" style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 4px; display: none;">
        <h3>Account Information</h3>
        <p><strong>Account Number:</strong> <span id="info-account-number"></span></p>
        <p><strong>Current Balance:</strong> <span id="info-balance"></span></p>
        <p><strong>Customer ID:</strong> <span id="info-customer"></span></p>
    </div>
</div>

<script>
const DEPOSIT_API_URL = 'http://localhost:5000/api/deposit-accounts';

function searchByAccountNumber() {
    const accountNumber = document.getElementById('account-number').value;
    if (!accountNumber) return;

    fetch(`${DEPOSIT_API_URL}/by-number/${accountNumber}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Account not found');
            }
            return response.json();
        })
        .then(account => {
            document.getElementById('account-id').value = account.id;
            showAccountInfo(account);
        })
        .catch(error => {
            showMessage('Account not found: ' + error.message, 'error');
        });
}

function showAccountInfo(account) {
    document.getElementById('info-account-number').textContent = account.accountNumber;
    document.getElementById('info-balance').textContent = formatCurrency(account.balance);
    document.getElementById('info-customer').textContent = account.customerId;
    document.getElementById('account-info').style.display = 'block';
}

function submitDeposit(event) {
    event.preventDefault();

    const accountId = document.getElementById('account-id').value;
    const amount = parseFloat(document.getElementById('amount').value);
    const description = document.getElementById('description').value || 'Deposit';

    fetch(`${DEPOSIT_API_URL}/${accountId}/deposit`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
            amount: amount,
            description: description
        })
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                throw new Error(text || 'Deposit failed');
            });
        }
        return response.json();
    })
    .then(data => {
        showMessage(`Deposit successful! New balance: ${formatCurrency(data.balance)}`, 'success');
        document.getElementById('deposit-form').reset();
        document.getElementById('account-info').style.display = 'none';
        setTimeout(() => {
            loadPage('deposit', 'list');
        }, 2000);
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Failed to process deposit: ' + error.message, 'error');
    });

    return false;
}

function formatCurrency(amount) {
    return new Intl.NumberFormat('fr-FR', { 
        style: 'currency', 
        currency: 'EUR' 
    }).format(amount);
}

function showMessage(message, type = 'success') {
    const container = document.getElementById('message-container');
    const className = type === 'success' ? 'success-message' : 'error-message';
    container.innerHTML = `<div class="${className}" style="padding: 10px; margin: 10px 0; border-radius: 4px; 
                            background: ${type === 'success' ? '#d4edda' : '#f8d7da'}; 
                            color: ${type === 'success' ? '#155724' : '#721c24'}; 
                            border: 1px solid ${type === 'success' ? '#c3e6cb' : '#f5c6cb'};">
                            ${message}
                           </div>`;
}
</script>
